@model List<ShopDomain.Models.Merchandise>

<div class="container-fluid mt-5">
    <h2 class="text-center mb-4">Мерч</h2>

    <div class="row">
        <!-- Панель фільтрів зліва (не фіксована) -->
        <div class="col-md-3 filter-panel">
            <form asp-action="Index" method="get" class="mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Фільтри</h5>
                    </div>
                    <div class="card-body bg-light">
                        <!-- Акордеон -->
                        <div class="accordion" id="filterAccordion">
                            <!-- Пошук -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSearch">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSearch" aria-expanded="true" aria-controls="collapseSearch">
                                        Пошук
                                    </button>
                                </h2>
                                <div id="collapseSearch" class="accordion-collapse collapse show" aria-labelledby="headingSearch" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <input type="text" name="searchString" class="form-control" placeholder="Пошук за назвою..." value="@ViewBag.SearchString" />
                                    </div>
                                </div>
                            </div>

                            <!-- Бренди -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingBrands">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBrands" aria-expanded="false" aria-controls="collapseBrands">
                                        Бренди
                                    </button>
                                </h2>
                                <div id="collapseBrands" class="accordion-collapse collapse" aria-labelledby="headingBrands" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        @foreach (var brand in ViewBag.Brands)
                                        {
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="brandIds" value="@brand.Id" id="brand_@brand.Id" @(ViewBag.BrandIds != null && ViewBag.BrandIds.Contains(brand.Id) ? "checked" : "") />
                                                <label class="form-check-label" for="brand_@brand.Id">@brand.BrandName</label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Категорії -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingCategories">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategories" aria-expanded="false" aria-controls="collapseCategories">
                                        Категорії
                                    </button>
                                </h2>
                                <div id="collapseCategories" class="accordion-collapse collapse" aria-labelledby="headingCategories" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        @foreach (var category in ViewBag.Categories)
                                        {
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="categoryIds" value="@category.Id" id="category_@category.Id" @(ViewBag.CategoryIds != null && ViewBag.CategoryIds.Contains(category.Id) ? "checked" : "") />
                                                <label class="form-check-label" for="category_@category.Id">@category.CategoryName</label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Розміри -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingSizes">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSizes" aria-expanded="false" aria-controls="collapseSizes">
                                        Розміри
                                    </button>
                                </h2>
                                <div id="collapseSizes" class="accordion-collapse collapse" aria-labelledby="headingSizes" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        @foreach (var size in ViewBag.Sizes)
                                        {
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="sizeIds" value="@size.Id" id="size_@size.Id" @(ViewBag.SizeIds != null && ViewBag.SizeIds.Contains(size.Id) ? "checked" : "") />
                                                <label class="form-check-label" for="size_@size.Id">@size.SizeName</label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Команди -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingTeams">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTeams" aria-expanded="false" aria-controls="collapseTeams">
                                        Команди
                                    </button>
                                </h2>
                                <div id="collapseTeams" class="accordion-collapse collapse" aria-labelledby="headingTeams" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        @foreach (var team in ViewBag.Teams)
                                        {
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" name="teamIds" value="@team.Id" id="team_@team.Id" @(ViewBag.TeamIds != null && ViewBag.TeamIds.Contains(team.Id) ? "checked" : "") />
                                                <label class="form-check-label" for="team_@team.Id">@team.TeamName</label>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Ціна -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingPrice">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrice" aria-expanded="false" aria-controls="collapsePrice">
                                        Ціна
                                    </button>
                                </h2>
                                <div id="collapsePrice" class="accordion-collapse collapse" aria-labelledby="headingPrice" data-bs-parent="#filterAccordion">
                                    <div class="accordion-body">
                                        <input type="number" name="minPrice" class="form-control mb-2" placeholder="Мін. ціна" step="0.01" min="0" value="@(ViewBag.MinPrice != null ? ViewBag.MinPrice.ToString() : "")" />
                                        <input type="number" name="maxPrice" class="form-control" placeholder="Макс. ціна" step="0.01" min="0" value="@(ViewBag.MaxPrice != null ? ViewBag.MaxPrice.ToString() : "")" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки -->
                        <div class="mt-3 d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Фільтрувати</button>
                            <a asp-action="Index" asp-route-clearFilters="true" class="btn btn-outline-secondary">Очистити</a>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Список товарів -->
        <div class="col-md-9 content-area">
            <div class="row">
                @if (Model.Any())
                {
                    @foreach (var merch in Model)
                    {
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 shadow-sm">
                                @if (!string.IsNullOrEmpty(merch.ImageUrl))
                                {
                                    <img src="@merch.ImageUrl" class="card-img-top" alt="@merch.Name" style="height: 200px; object-fit: cover;" />
                                }
                                else
                                {
                                    <img src="~/images/default-merch.jpg" class="card-img-top" alt="Без фото" style="height: 200px; object-fit: cover;" />
                                }
                                <div class="card-body">
                                    <h5 class="card-title">@merch.Name</h5>
                                    <p class="card-text">@merch.Price.ToString("C")</p>
                                    <p class="card-text"><small class="text-muted">Бренд: @(merch.Brand?.BrandName ?? "Немає")</small></p>
                                    <p class="card-text"><small class="text-muted">Категорія: @(merch.Category?.CategoryName ?? "Немає")</small></p>
                                    <p class="card-text"><small class="text-muted">Розмір: @(merch.Size?.SizeName ?? "Немає")</small></p>
                                    <p class="card-text"><small class="text-muted">Команда: @(merch.Team?.TeamName ?? "Немає")</small></p>
                                    <a asp-action="Details" asp-route-id="@merch.Id" class="btn btn-info btn-sm">Деталі</a>
                                    <button class="btn btn-primary btn-sm add-to-cart" data-merchandise-id="@merch.Id">Додати в кошик</button>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-center">
                        <p class="text-muted">Товари не знайдено. Спробуйте змінити фільтри.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .filter-panel {
        position: static; /* Не фіксований, розміщується в потоці */
        width: 100%; /* Повна ширина в межах col-md-3 */
        padding: 15px;
        background-color: #fff;
    }

    .accordion-button {
        font-weight: 500;
        background-color: #f8f9fa;
    }

        .accordion-button:not(.collapsed) {
            color: #0d6efd;
            background-color: #e7f1ff;
        }

    .card {
        border: none;
        border-radius: 10px;
    }

    .card-body {
        padding: 1.5rem;
    }

    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }

    .content-area {
        padding: 15px; /* Відступи для контенту */
    }
</style>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', addToCart);
            });
        });

        function addToCart(event) {
            const button = event.target;
            const merchandiseId = parseInt(button.getAttribute('data-merchandise-id'));
            const userId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';

            fetch('/api/Cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ merchandiseId, quantity: 1 })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Помилка додавання до кошика: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                updateCartCount();
            })
            .catch(error => {
                console.error('Error adding to cart:', error);
                alert('Не вдалося додати товар до кошика.');
            });
        }
    </script>
}